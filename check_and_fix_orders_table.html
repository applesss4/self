<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>检查和修复订单表结构</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        button {
            padding: 10px 15px;
            margin: 5px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 3px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        pre {
            background-color: #f8f9fa;
            padding: 10px;
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        table, th, td {
            border: 1px solid #ddd;
        }
        th, td {
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>
    <h1>检查和修复订单表结构</h1>
    
    <div class="test-section">
        <h2>说明</h2>
        <p>此页面用于检查和修复 orders 表的结构问题，特别是 total 字段相关的约束。</p>
    </div>
    
    <div class="test-section">
        <h2>状态信息</h2>
        <div id="status">正在初始化...</div>
    </div>
    
    <div class="test-section">
        <h2>操作按钮</h2>
        <button id="checkAuth">检查认证状态</button>
        <button id="checkTableStructure">检查表结构</button>
        <button id="fixTableStructure">修复表结构</button>
        <button id="testOrderCreation">测试订单创建</button>
        <button id="clearResults">清除结果</button>
    </div>
    
    <div class="test-section">
        <h2>表结构信息</h2>
        <div id="tableStructure"></div>
    </div>
    
    <div class="test-section">
        <h2>测试结果</h2>
        <div id="results"></div>
    </div>
    
    <div class="test-section">
        <h2>详细日志</h2>
        <pre id="consoleOutput"></pre>
    </div>

    <script type="module">
        import supabase from './js/supabase.js';
        import SupabaseAuth from './js/supabaseAuth.js';
        
        // 重写console.log以便在页面上显示
        const originalLog = console.log;
        const consoleOutput = document.getElementById('consoleOutput');
        console.log = function(...args) {
            originalLog.apply(console, args);
            const logEntry = document.createElement('div');
            logEntry.textContent = args.join(' ');
            consoleOutput.appendChild(logEntry);
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        };
        
        // 重写console.error
        const originalError = console.error;
        console.error = function(...args) {
            originalError.apply(console, args);
            const logEntry = document.createElement('div');
            logEntry.textContent = 'ERROR: ' + args.join(' ');
            logEntry.style.color = 'red';
            consoleOutput.appendChild(logEntry);
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        };
        
        // 重写console.warn
        const originalWarn = console.warn;
        console.warn = function(...args) {
            originalWarn.apply(console, args);
            const logEntry = document.createElement('div');
            logEntry.textContent = 'WARN: ' + args.join(' ');
            logEntry.style.color = 'orange';
            consoleOutput.appendChild(logEntry);
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        };
        
        // 初始化组件
        const auth = new SupabaseAuth();
        
        // 更新状态显示
        document.getElementById('status').textContent = '初始化完成';
        
        // 检查认证状态按钮
        document.getElementById('checkAuth').addEventListener('click', async () => {
            try {
                const user = await auth.getCurrentUser();
                if (user) {
                    showResult('用户已登录: ' + user.email, 'success');
                } else {
                    showResult('用户未登录', 'error');
                }
            } catch (error) {
                showResult('检查认证状态时出错: ' + error.message, 'error');
            }
        });
        
        // 检查表结构按钮
        document.getElementById('checkTableStructure').addEventListener('click', async () => {
            try {
                const user = await auth.getCurrentUser();
                if (!user) {
                    showResult('请先登录才能检查表结构', 'error');
                    return;
                }
                
                console.log('开始检查 orders 表结构...');
                
                // 查询表结构信息
                const { data, error } = await supabase
                    .from('orders')
                    .select('*')
                    .limit(1);
                
                if (error && error.code !== '42P01') { // 42P01 表示表不存在
                    console.error('查询表结构失败:', error);
                    showResult('查询表结构失败: ' + error.message, 'error');
                    return;
                }
                
                // 如果表不存在或为空，插入一个测试记录来获取结构
                if (!data || data.length === 0) {
                    console.log('表为空或不存在，插入测试记录');
                    const { data: testData, error: testError } = await supabase
                        .from('orders')
                        .insert({
                            user_id: user.id,
                            items: [],
                            total: 0,
                            total_amount: 0
                        })
                        .select()
                        .single();
                    
                    if (testError) {
                        console.error('插入测试记录失败:', testError);
                        showResult('插入测试记录失败: ' + testError.message, 'error');
                        return;
                    }
                    
                    // 删除测试记录
                    await supabase
                        .from('orders')
                        .delete()
                        .eq('id', testData.id);
                    
                    // 重新查询结构
                    const { data: newData, error: newError } = await supabase
                        .from('orders')
                        .select('*')
                        .limit(1);
                    
                    if (newError) {
                        console.error('重新查询表结构失败:', newError);
                        showResult('重新查询表结构失败: ' + newError.message, 'error');
                        return;
                    }
                    
                    displayTableStructure(newData);
                } else {
                    displayTableStructure(data);
                }
                
                showResult('表结构检查完成', 'success');
            } catch (error) {
                showResult('检查表结构时出错: ' + error.message, 'error');
                console.error('检查表结构错误:', error);
            }
        });
        
        // 修复表结构按钮
        document.getElementById('fixTableStructure').addEventListener('click', async () => {
            try {
                const user = await auth.getCurrentUser();
                if (!user) {
                    showResult('请先登录才能修复表结构', 'error');
                    return;
                }
                
                console.log('开始修复 orders 表结构...');
                
                // 尝试执行修复语句
                const fixStatements = [
                    // 重命名字段（如果存在total_amount）
                    `ALTER TABLE IF EXISTS public.orders RENAME COLUMN IF EXISTS total_amount TO total;`,
                    // 确保total字段存在
                    `ALTER TABLE IF EXISTS public.orders ADD COLUMN IF NOT EXISTS total DECIMAL(10, 2);`,
                    // 确保total字段不为空
                    `ALTER TABLE IF EXISTS public.orders ALTER COLUMN total SET NOT NULL;`,
                    // 删除旧的total_amount字段（如果还存在）
                    `ALTER TABLE IF EXISTS public.orders DROP COLUMN IF EXISTS total_amount;`
                ];
                
                let successCount = 0;
                for (let i = 0; i < fixStatements.length; i++) {
                    const statement = fixStatements[i];
                    console.log(`尝试执行语句 ${i+1}/${fixStatements.length}: ${statement}`);
                    
                    try {
                        // 注意：在实际应用中，这些DDL语句需要在Supabase控制台中执行
                        // 这里只是显示语句供参考
                        console.warn('注意：DDL语句需要在Supabase控制台中手动执行');
                        console.log(statement);
                        successCount++;
                        showResult(`修复语句 ${i+1} 已生成（请手动执行）`, 'warning');
                    } catch (error) {
                        console.error(`执行语句失败: ${error.message}`);
                        showResult(`执行语句失败: ${error.message}`, 'error');
                    }
                }
                
                if (successCount === fixStatements.length) {
                    showResult('所有修复语句已生成，请在Supabase控制台中手动执行', 'warning');
                } else {
                    showResult(`部分修复语句生成完成 (${successCount}/${fixStatements.length})`, 'warning');
                }
            } catch (error) {
                showResult('修复表结构时出错: ' + error.message, 'error');
                console.error('修复表结构错误:', error);
            }
        });
        
        // 测试订单创建按钮
        document.getElementById('testOrderCreation').addEventListener('click', async () => {
            try {
                const user = await auth.getCurrentUser();
                if (!user) {
                    showResult('请先登录才能测试订单创建', 'error');
                    return;
                }
                
                // 创建测试订单数据
                const testOrder = {
                    items: [
                        {
                            id: 'test-item-1',
                            name: '测试商品1',
                            price: 99.99,
                            quantity: 2,
                            supermarkets: [{ name: '沃尔玛', price: 99.99 }]
                        }
                    ],
                    total: 199.98
                };
                
                console.log('准备创建测试订单:', testOrder);
                
                // 准备插入的数据（同时包含total和total_amount）
                const orderData = {
                    user_id: user.id,
                    items: testOrder.items,
                    total: testOrder.total,
                    total_amount: testOrder.total, // 兼容旧结构
                    date: new Date().toISOString()
                };
                
                console.log('准备插入订单数据:', orderData);
                
                // 插入订单
                const { data, error } = await supabase
                    .from('orders')
                    .insert(orderData)
                    .select()
                    .single();
                
                if (error) {
                    console.error('订单创建失败:', error);
                    showResult('订单创建失败: ' + error.message, 'error');
                    return;
                }
                
                console.log('订单创建成功:', data);
                showResult(`订单创建成功！订单号: ${data.id}`, 'success');
                
                // 删除测试订单
                await supabase
                    .from('orders')
                    .delete()
                    .eq('id', data.id);
                
                showResult('测试订单已清理', 'success');
            } catch (error) {
                showResult('测试订单创建时出错: ' + error.message, 'error');
                console.error('测试订单创建错误:', error);
            }
        });
        
        // 清除结果按钮
        document.getElementById('clearResults').addEventListener('click', () => {
            document.getElementById('results').innerHTML = '';
            consoleOutput.innerHTML = '';
            document.getElementById('tableStructure').innerHTML = '';
        });
        
        // 显示表结构
        function displayTableStructure(data) {
            const structureDiv = document.getElementById('tableStructure');
            structureDiv.innerHTML = '';
            
            if (!data || data.length === 0) {
                structureDiv.innerHTML = '<p>无数据</p>';
                return;
            }
            
            const record = data[0];
            const table = document.createElement('table');
            
            // 表头
            const headerRow = document.createElement('tr');
            const fieldHeader = document.createElement('th');
            fieldHeader.textContent = '字段名';
            const typeHeader = document.createElement('th');
            typeHeader.textContent = '值';
            headerRow.appendChild(fieldHeader);
            headerRow.appendChild(typeHeader);
            table.appendChild(headerRow);
            
            // 字段数据
            Object.keys(record).forEach(key => {
                const row = document.createElement('tr');
                const fieldCell = document.createElement('td');
                fieldCell.textContent = key;
                const valueCell = document.createElement('td');
                valueCell.textContent = JSON.stringify(record[key]);
                row.appendChild(fieldCell);
                row.appendChild(valueCell);
                table.appendChild(row);
            });
            
            structureDiv.appendChild(table);
        }
        
        // 显示结果函数
        function showResult(message, type) {
            const resultDiv = document.createElement('div');
            resultDiv.className = `result ${type}`;
            resultDiv.textContent = message;
            document.getElementById('results').appendChild(resultDiv);
        }
    </script>
</body>
</html>