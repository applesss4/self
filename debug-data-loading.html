<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据加载调试页面</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"></script>
    <link rel="stylesheet" href="css/styles.css?v=1.0.37">
    <script src="js/config.js?v=1.0.37"></script>
    <script src="js/supabaseAuth.js?v=1.0.37"></script>
    <script src="js/supabaseStorage.js?v=1.0.37"></script>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-center mb-8 text-gray-800">数据加载调试页面</h1>
        
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">调试信息</h2>
            <div id="debug-info" class="space-y-2">
                <p>正在初始化调试...</p>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">认证状态</h2>
            <div id="auth-status" class="space-y-2">
                <p>检查中...</p>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">数据加载测试</h2>
            <button id="test-load-btn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                测试数据加载
            </button>
            <div id="data-results" class="mt-4 space-y-2">
                <p>等待测试...</p>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4">操作</h2>
            <button id="back-to-tasks" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded mr-2">
                返回任务页面
            </button>
            <button id="logout-btn" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">
                登出
            </button>
        </div>
    </div>

    <script>
        // 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', async function() {
            const debugInfo = document.getElementById('debug-info');
            const authStatus = document.getElementById('auth-status');
            const dataResults = document.getElementById('data-results');
            
            // 显示基本信息
            debugInfo.innerHTML = `
                <p><strong>当前时间:</strong> ${new Date().toLocaleString()}</p>
                <p><strong>用户代理:</strong> ${navigator.userAgent}</p>
                <p><strong>在线状态:</strong> ${navigator.onLine ? '在线' : '离线'}</p>
            `;
            
            try {
                // 检查认证状态
                console.log('开始检查认证状态...');
                const supabaseAuth = SupabaseAuth.getInstance();
                console.log('SupabaseAuth实例:', supabaseAuth);
                
                const currentUser = await supabaseAuth.getCurrentUser();
                console.log('当前用户:', currentUser);
                
                if (currentUser) {
                    authStatus.innerHTML = `
                        <p class="text-green-600"><strong>认证状态:</strong> 已登录</p>
                        <p><strong>用户ID:</strong> ${currentUser.id}</p>
                        <p><strong>用户邮箱:</strong> ${currentUser.email}</p>
                        <p><strong>认证时间:</strong> ${new Date().toLocaleString()}</p>
                    `;
                } else {
                    authStatus.innerHTML = `
                        <p class="text-red-600"><strong>认证状态:</strong> 未登录</p>
                        <button id="login-btn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded mt-2">
                            前往登录
                        </button>
                    `;
                    document.getElementById('login-btn').addEventListener('click', () => {
                        window.location.href = 'login.html';
                    });
                    return;
                }
                
                // 绑定事件
                document.getElementById('test-load-btn').addEventListener('click', testDataLoading);
                document.getElementById('back-to-tasks').addEventListener('click', () => {
                    window.location.href = 'tasks.html';
                });
                document.getElementById('logout-btn').addEventListener('click', async () => {
                    await supabaseAuth.signOut();
                    window.location.href = 'login.html';
                });
                
            } catch (error) {
                console.error('检查认证状态时出错:', error);
                authStatus.innerHTML = `
                    <p class="text-red-600"><strong>认证检查失败:</strong> ${error.message}</p>
                `;
            }
        });
        
        // 测试数据加载
        async function testDataLoading() {
            const dataResults = document.getElementById('data-results');
            dataResults.innerHTML = '<p>正在测试数据加载...</p>';
            
            try {
                console.log('开始测试数据加载...');
                // 创建SupabaseStorage实例
                const storage = new SupabaseStorage();
                console.log('SupabaseStorage实例创建完成');
                
                // 尝试获取所有任务
                console.log('开始获取任务数据...');
                const tasks = await storage.getAllTasks();
                console.log('获取到的任务数据:', tasks);
                
                if (tasks && Array.isArray(tasks)) {
                    dataResults.innerHTML = `
                        <p class="text-green-600"><strong>数据加载成功!</strong></p>
                        <p><strong>任务数量:</strong> ${tasks.length}</p>
                        <div class="mt-2">
                            <h3 class="font-semibold">任务列表:</h3>
                            <pre class="bg-gray-100 p-2 mt-2 rounded text-sm overflow-auto">${JSON.stringify(tasks, null, 2)}</pre>
                        </div>
                    `;
                } else {
                    dataResults.innerHTML = `
                        <p class="text-yellow-600"><strong>数据加载完成，但返回格式异常:</strong></p>
                        <pre class="bg-gray-100 p-2 mt-2 rounded text-sm overflow-auto">${JSON.stringify(tasks, null, 2)}</pre>
                    `;
                }
            } catch (error) {
                console.error('数据加载测试失败:', error);
                dataResults.innerHTML = `
                    <p class="text-red-600"><strong>数据加载失败:</strong></p>
                    <p>${error.message}</p>
                    <pre class="bg-gray-100 p-2 mt-2 rounded text-sm overflow-auto">${error.stack}</pre>
                `;
            }
        }
    </script>
</body>
</html>